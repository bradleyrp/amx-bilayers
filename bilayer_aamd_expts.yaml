bilayer_control_aamd_restrain:
  tags:
    - aamd
    - tag_prelim
    - tested_else # tested with bilayer_control_aamd_test
  params: None
  extensions: "@extras/geometry_tools"
  quick: |
    from amx import *
    init()
    restraint_maker()
  settings:
    USAGE NOTES: |
      this method is designed to pre-make any lipid restraints you might want
      its product can be used by 
        (1) the bilayer maker's vacuum packing
        (2) the flat bilayer maker's leaflet-specific restraints
      the "wants" dictionary specifies the outputs and describes their restraints
      the deposit site holds the automatically generated force fields
      this method completely avoids using the "define posre" flags in GROMACS
      all restraints are explicit, but this means you should avoid "define posre" which will restrain water
      note that this experiment was copied nearly verbatim from the lipidome_expts.py
      the quick script restraint function has been generalized 
        and moved from the martini bundle to topology_tools.py
    force field: charmm                      # we always include the force field for the Landscape class
    base force field: "@charmm/charmm36.ff"  # source force field to modify
    deposit site: "@charmm/auto_ff"          # where to write new force fields (keys in wants)
    wants:
      charmm36_upright.ff:
        - restraints:
            heavy: {'z':10}
            heavy: {'z':10}
          naming: same
          which: lipids
        - restraints:
            charmm_glycerol: {'z':1000}
            charmm_tails: {'z':1000}
          naming: same
          which: lipids
        - restraints:
            sterol_out: {'z':1000}
            sterol_in: {'z':1000}
          naming: same
          which: sterols
      charmm36_restrain.ff:
        - restraints:
            charmm_glycerol: {'x':500,'y':500,'z':500}
            charmm_tails: {'x':500,'y':500,'z':500}
          naming: same
          which: lipids
        - restraints:
            sterol_out: {'x':500,'y':500,'z':500}
            sterol_in: {'x':500,'y':500,'z':500}
          naming: same
          which: sterols

bilayer_control_aamd_test_small:
  tags:
  - aamd
  - note_structure_repo
  - tested_2018.05.02
  script: scripts/bilayer.py
  params: parameters-aamd.py
  extensions: 
    - "@extras"
    - "@bilayers/codes"
  settings:
    USAGE NOTES: |
      use this procedure to make a "free" bilayer
      this method packs lipids in vacuum with restraints
      requires restrains generated via a run named "generate_lipidome_restraints"
      this small test was the first test after porting the cgmd method into "new automacs"
      this method is largely deprecated by the bilayer-careful script used by bilayer_control_aamd_test
    step: bilayer
    shape:              flat            # initial mesh shape flat
    aspect:             1.0             # XY proportion for flat bilayers
    binsize:            1.2             # grid spacing for initial lipid configuration
    monolayer offset:   1.5             # initial distance between leaflets 
    monolayer top:      36              # number of lipids in the top leaflet
    monolayer bottom:   37              # number of lipids in the bottom leaflet (none for symmetric)
    # folder for lipid structures
    lipid structures: "@structure-repo/bilayers-aamd/lipid-structures"
    # colloquial types for different molecules
    landscape metadata: "@charmm/landscape.json" 
    # COMPOSITIONS (propotional -- no need to sum to unity)
    composition top:    {'DOPC':1,'DOPS':0,'PI2P':3,'CHL1':0}
    composition bottom: {'POPC':4,'CHL1':0}
    # SOLVATION
    cation:             NA              # residue name for the cation (must be found in the ff)
    anion:              CL              # residue name for the anion (must be found in the ff)
    ionic strength:     0.150           # molar ionic strength
    sol:                SOL             # residue name for water
    atom resolution:    cgmd            # either cgmd or aamd
    water buffer:       8               # water-other gap distance in Angstroms (avoid waters in bilayer!)
    solvent:            spc216          # water box (must be copied via files)
    thickness:          10              # thickness of the box at the solvate step
                                        #   be careful with this. you can get widely varying levels of water
    # COPY DEPENDENCIES
    files: []
    sources: ['@charmm/charmm36.ff','@charmm/auto_ff/charmm36_upright.ff']
    # FORCE FIELD (use GROMACS shared force fields or copy e.g. name.ff via sources)
    force field: charmm36
    force field upright: charmm36_upright
    # INTEGRATOR PARAMETERS
    equilibration: 
      - npt-bilayer-short
      - npt-bilayer
    mdp specs:
      group: aamd
      mdps:
        input-em-steep-in.mdp: ['minimize',{'potential':'verlet','emtol':10}]
        input-md-vacuum-pack1-eq-in.mdp: [
          'vacuum-packing',{'nsteps':10000,'dt':0.0001,
          'compressibility':'3e-6 0','tau_p':0.1}]
        input-md-vacuum-pack2-eq-in.mdp: ['vacuum-packing',{'nsteps':10000,'dt':0.001}]
        input-md-vacuum-pack3-eq-in.mdp: ['vacuum-packing',{'ref_p':'500.0 1.0'}]
        input-md-vacuum-pack4-eq-in.mdp: ['vacuum-packing']
        input-md-npt-bilayer-eq-in.mdp: ['npt-bilayer-simple',]
        input-md-npt-bilayer-short-eq-in.mdp: ['npt-bilayer',{'dt':0.0002,'nsteps':10000}]
        input-md-in.mdp: ['npt-bilayer']
    maxwarn: 1

membrane-v561-dense-small:
  tags:
  - aamd
  - note_structure_repo
  - tested_2018.05.02
  script: scripts/bilayer-careful.py
  params: parameters-aamd.py
  extensions: 
    - "@extras"
    - "@bilayers/codes"
  settings:
    USAGE NOTES: |
      use this procedure to make a "free" bilayer
      this method packs lipids in vacuum with restraints
      requires restrains generated via a run named "generate_lipidome_restraints"
      this small test was the first test after porting the cgmd method into "new automacs"
      this method is largely deprecated by the bilayer-careful script used by bilayer_control_aamd_test
    step: bilayer
    shape:              flat            # initial mesh shape flat
    aspect:             1.0             # XY proportion for flat bilayers
    binsize:            1.2             # grid spacing for initial lipid configuration
    monolayer offset:   1.5             # initial distance between leaflets 
    monolayer top:      20              # number of lipids in the top leaflet
    monolayer bottom:   20              # number of lipids in the bottom leaflet (none for symmetric)
    # folder for lipid structures
    lipid structures: "@structure-repo/bilayers-aamd/lipid-structures"
    # colloquial types for different molecules
    landscape metadata: "@charmm/landscape.json" 
    # COMPOSITIONS (propotional -- no need to sum to unity)
    composition top:    {'DOPC':1,'DOPS':0,'PI2P':3,'CHL1':0}
    composition bottom: {'POPC':4,'CHL1':0}
    # SOLVATION
    cation:             NA              # residue name for the cation (must be found in the ff)
    anion:              CL              # residue name for the anion (must be found in the ff)
    ionic strength:     0.150           # molar ionic strength
    sol:                SOL             # residue name for water
    atom resolution:    cgmd            # either cgmd or aamd
    water buffer:       8               # water-other gap distance in Angstroms (avoid waters in bilayer!)
    solvent:            spc216          # water box (must be copied via files)
    thickness:          12              # thickness of the box at the solvate step
                                        #   be careful with this. you can get widely varying levels of water
    # COPY DEPENDENCIES
    files: []
    sources: 
      - "@charmm/charmm36.ff"
      - "@charmm/auto_ff/charmm36_upright.ff"
      - "@charmm/auto_ff/charmm36_restrain.ff"
    # FORCE FIELD (use GROMACS shared force fields or copy e.g. name.ff via sources)
    force field: charmm36
    force field upright: charmm36_upright
    force field restrain: charmm36_restrain
    # INTEGRATOR PARAMETERS
    equilibration: 
      - npt-bilayer-short
      - npt-bilayer
    mdp specs:
      group: aamd
      mdps:
        input-em-steep-in.mdp: ['minimize',{'potential':'bilayer-pack','emtol':10,'screening':'off'}]
        input-md-vacuum-pack1-eq-in.mdp: [
          'vacuum-packing',{'nsteps':10000,'dt':0.001}]
        input-md-vacuum-pack2-eq-in.mdp: ['vacuum-packing',{'ref_p':'500.0 1.0'}]
        input-md-vacuum-pack3-eq-in.mdp: ['vacuum-packing']
        input-md-bilayer-s1-restr-eq-in.mdp: ['npt-bilayer-simple',
          {'dt':0.0001,'nsteps':50000,'compressibility':'0.0 4.5e-5',
            'restrain':'posre-com-only','tau_p':0.1}]
        input-md-bilayer-s2-restr-eq-in.mdp: ['npt-bilayer-simple',
          {'dt':0.0002,'nsteps':50000,'compressibility':'0.0 4.5e-5',
            'restrain':'posre-com-only','tau_p':0.5}]
        input-md-bilayer-s3-free-eq-in.mdp: ['npt-bilayer-simple',
          {'dt':0.0002,'nsteps':50000,'compressibility':'0.0 4.5e-5',
            'restrain':'posre-com-only','tau_p':0.5}]
        input-md-bilayer-s4-free-eq-in.mdp: ['npt-bilayer-simple',
          {'dt':0.001,'nsteps':50000,'compressibility':'0.0 4.5e-5',
            'restrain':'posre-com-only','tau_p':0.5}]
        input-md-bilayer-s5-free-eq-in.mdp: ['npt-bilayer-simple',
          {'dt':0.002,'nsteps':50000,'restrain':'posre-com-only','tau_p':0.5}]
        input-md-bilayer-eq-in.mdp: ['npt-bilayer',
          {'dt':0.002,'nsteps':100000,'restrain':'posre-com-only'}]
        input-md-in.mdp: ['npt-bilayer',{'restrain':'posre-com-only','nsteps':500000}]
    equilibrate_restrain: ['bilayer-s1-restr','bilayer-s2-restr']
    equilibrate_free: ['bilayer-s3-free','bilayer-s4-free','bilayer-s5-free','bilayer']
    equilibrate_restrain_final: "md-bilayer-s2-restr"
    maxwarn: 2

ptdins_study_base:
  tags:
  - aamd
  - note_structure_repo
  # tag to indicate this is part of the example ptdins_study
  script: scripts/bilayer-careful.py
  params: parameters-aamd.py
  extensions: 
    - "@extras"
    - "@bilayers/codes"
  settings:
    USAGE NOTES: |
      use this procedure to make a "free" bilayer
      this method packs lipids in vacuum with restraints
      requires restrains generated via a run named "generate_lipidome_restraints"
      this small test was the first test after porting the cgmd method into "new automacs"
      this method is largely deprecated by the bilayer-careful script used by bilayer_control_aamd_test
    step: bilayer
    shape:              flat            # initial mesh shape flat
    aspect:             1.0             # XY proportion for flat bilayers
    binsize:            1.2             # grid spacing for initial lipid configuration
    monolayer offset:   1.5             # initial distance between leaflets 
    monolayer top:      40              # number of lipids in the top leaflet
    monolayer bottom:   40              # number of lipids in the bottom leaflet (none for symmetric)
    # folder for lipid structures
    lipid structures: "@structure-repo/bilayers-aamd/lipid-structures"
    # colloquial types for different molecules
    landscape metadata: "@charmm/landscape.json" 
    # COMPOSITIONS (propotional -- no need to sum to unity)
    composition top:    {'DOPE':200.0,'DOPS':60.0,'PI2P':40.0,'CHL1':100.0}
    composition bottom: {'POPC':300.0,'CHL1':100.0}

    # SOLVATION
    cation:             NA              # residue name for the cation (must be found in the ff)
    anion:              CL              # residue name for the anion (must be found in the ff)
    ionic strength:     0.150           # molar ionic strength
    sol:                SOL             # residue name for water
    atom resolution:    cgmd            # either cgmd or aamd
    water buffer:       8               # water-other gap distance in Angstroms (avoid waters in bilayer!)
    solvent:            spc216          # water box (must be copied via files)
    thickness:          12              # thickness of the box at the solvate step
                                        #   be careful with this. you can get widely varying levels of water
    # COPY DEPENDENCIES
    files: []
    sources: 
      - "@charmm/charmm36.ff"
      - "@charmm/auto_ff/charmm36_upright.ff"
      - "@charmm/auto_ff/charmm36_restrain.ff"
    # FORCE FIELD (use GROMACS shared force fields or copy e.g. name.ff via sources)
    force field: charmm36
    force field upright: charmm36_upright
    force field restrain: charmm36_restrain
    # INTEGRATOR PARAMETERS
    equilibration: 
      - npt-bilayer-short
      - npt-bilayer
    mdp specs:
      group: aamd
      mdps:
        input-em-steep-in.mdp: ['minimize',{'potential':'bilayer-pack','emtol':10,'screening':'off'}]
        input-md-vacuum-pack1-eq-in.mdp: [
          'vacuum-packing',{'nsteps':10000,'dt':0.001}]
        input-md-vacuum-pack2-eq-in.mdp: ['vacuum-packing',{'ref_p':'500.0 1.0'}]
        input-md-vacuum-pack3-eq-in.mdp: ['vacuum-packing']
        input-md-bilayer-s1-restr-eq-in.mdp: ['npt-bilayer-simple',
          {'dt':0.0001,'nsteps':50000,'compressibility':'0.0 4.5e-5',
            'restrain':'posre-com-only','tau_p':0.1}]
        input-md-bilayer-s2-restr-eq-in.mdp: ['npt-bilayer-simple',
          {'dt':0.0002,'nsteps':50000,'compressibility':'0.0 4.5e-5',
            'restrain':'posre-com-only','tau_p':0.5}]
        input-md-bilayer-s3-free-eq-in.mdp: ['npt-bilayer-simple',
          {'dt':0.0002,'nsteps':50000,'compressibility':'0.0 4.5e-5',
            'restrain':'posre-com-only','tau_p':0.5}]
        input-md-bilayer-s4-free-eq-in.mdp: ['npt-bilayer-simple',
          {'dt':0.001,'nsteps':50000,'compressibility':'0.0 4.5e-5',
            'restrain':'posre-com-only','tau_p':0.5}]
        input-md-bilayer-s5-free-eq-in.mdp: ['npt-bilayer-simple',
          {'dt':0.002,'nsteps':50000,'restrain':'posre-com-only','tau_p':0.5}]
        input-md-bilayer-eq-in.mdp: ['npt-bilayer',
          {'dt':0.002,'nsteps':100000,'restrain':'posre-com-only'}]
        input-md-in.mdp: ['npt-bilayer',{'restrain':'posre-com-only','nsteps':500000}]
    equilibrate_restrain: ['bilayer-s1-restr','bilayer-s2-restr']
    equilibrate_free: ['bilayer-s3-free','bilayer-s4-free','bilayer-s5-free','bilayer']
    equilibrate_restrain_final: "md-bilayer-s2-restr"
    maxwarn: 2

s2: #solvate_bilayer_replicate:
  tags:
  - aamd
  - piecewise
  - requires_another_structure #! find the correct term you were using
  script: scripts/bilayer-solvate-exact.py
  extends: ptdins_study_base
  settings:
    USAGE NOTES: |
      a single stage in a procedure for making bilayer replicates for preexisting simulations
      goal is to solvate with an exact amount of water
      !!! develop this into a metarun at some point
    files: 
      - inputs/vacuum-packed.gro
      - inputs/md-vacuum-pack3.ndx
      - inputs/md-vacuum-pack3.tpr
    incoming: vacuum-packed.gro # redundant with above
    water: 1000
    thickness: 12
    step: solvate

s2b: #solvate_bilayer_replicate:
  tags:
  - aamd
  - piecewise
  - requires_another_structure #! find the correct term you were using
  script: scripts/bilayer-solvate-exact.py
  extends: ptdins_study_base
  settings:
    USAGE NOTES: |
      a single stage in a procedure for making bilayer replicates for preexisting simulations
      goal is to solvate with an exact amount of water
      !!! develop this into a metarun at some point
    files: 
      - inputs/vacuum-packed.gro
      - inputs/md-vacuum-pack3.ndx
      - inputs/md-vacuum-pack3.tpr
    counterions header: False
    incoming: vacuum-packed.gro # redundant with above
    water: 1000
    thickness: 12
    step: solvate
    genion overrides:
      np: 10
      pq: 1
      nn: 10
      nq: -1
